import SwiftUI
import AVFoundation

// Ê∑ªÂä†Ê™¢Ê∏¨ÁÄèÊµ∑ÁöÑÂ∑•ÂÖ∑
extension View {
    func hasNotch() -> Bool {
        let keyWindow = UIApplication.shared.windows.filter { $0.isKeyWindow }.first
        return keyWindow?.safeAreaInsets.top ?? 0 > 20
    }
}

struct LemonView: View {
    @ObservedObject var viewModel: LemonViewModel
    @State private var showSettings = false
    @State private var lemonScale: CGFloat = 1.0
    @State private var juiceImages: [(offset: CGSize, scale: CGFloat, opacity: Double)] = []
    @State private var fallingLemons: [(id: UUID, yOffset: CGFloat, xOffset: CGFloat, finalYOffset: CGFloat, opacity: Double)] = []
    @State private var showLemonTip = false
    @State private var showStolenTip = false
    @AppStorage("soundEnabled") private var soundEnabled = true
    @AppStorage("vibrationEnabled") private var vibrationEnabled = true
    @AppStorage("fallingAnimationEnabled") private var fallingAnimationEnabled = true
    
    private let soundPlayer = try? AVAudioPlayer(contentsOf: Bundle.main.url(forResource: "pop sound", withExtension: "mp3")!)
    private let screenHeight = UIScreen.main.bounds.height
    private let lemonSize: CGFloat = 30
    private let maxStackHeight: CGFloat = UIScreen.main.bounds.height * 0.6
    
    var body: some View {
        ZStack {
            Image("background")
                .resizable()
                .scaledToFill()
                .edgesIgnoringSafeArea(.all)
            
            VStack(alignment: .leading, spacing: 0) {
                // Ê®ôÈ°åÂàó
                HStack {
                    Text("‰ªäÂ§©‰Ω†Ë¢´ÂÅ∑‰∫ÜÂóéÔºü")
                        .font(.system(size: 25, weight: .bold))
                        .lineLimit(1)
                        .minimumScaleFactor(0.8)
                    Spacer()
                    Button(action: {
                        showSettings = true
                    }) {
                        Image(systemName: "gearshape.fill")
                            .font(.system(size: 22))
                            .foregroundColor(.black)
                    }
                }
                .padding(.top, hasNotch() ? 90 : 120)
                .padding(.horizontal, 20)
                
                HStack(spacing: 15) {
                    // ‰ªäÊó•Ê¶®Ê™∏Ê™¨
                    VStack(alignment: .leading, spacing: 10) {
                        Text("\(viewModel.stats.todayLemonCount)")
                            .font(.system(size: 32, weight: .bold))
                            .lineLimit(1)
                            .minimumScaleFactor(0.8)
                            .fixedSize(horizontal: false, vertical: true)
                        Text("üòÄÊìÅÊúâÊ™∏Ê™¨Ê±ÅÔºàÊùØÔºâ")
                            .font(.system(size: 14))
                            .foregroundColor(.orange)
                            .lineLimit(1)
                            .minimumScaleFactor(0.6)
                            .fixedSize(horizontal: false, vertical: true)
                    }
                    .padding(.vertical, 12)
                    .padding(.horizontal, 16)
                    .frame(maxWidth: .infinity, alignment: .leading)
                    .background(RoundedRectangle(cornerRadius: 15).fill(Color.white))
                    .shadow(color: Color.black.opacity(0.05), radius: 5, x: 0, y: 2)
                    .onTapGesture {
                        showLemonTip.toggle()
                    }
                    
                    // ‰ªäÊó•Ë¢´ÂÅ∑
                    VStack(alignment: .leading, spacing: 10) {
                        Text("\(viewModel.stats.todayStolenCount)")
                            .font(.system(size: 30, weight: .bold))
                            .lineLimit(1)
                            .minimumScaleFactor(0.8)
                            .fixedSize(horizontal: false, vertical: true)
                        Text("üò≠‰ªäÊó•Ë¢´ÂÅ∑ÔºàÊùØÔºâ")
                            .font(.system(size: 14))
                            .foregroundColor(.orange)
                            .lineLimit(1)
                            .minimumScaleFactor(0.8)
                            .fixedSize(horizontal: false, vertical: true)
                    }
                    .padding(.vertical, 12)
                    .padding(.horizontal, 16)
                    .frame(maxWidth: .infinity, alignment: .leading)
                    .background(RoundedRectangle(cornerRadius: 15).fill(Color.white))
                    .shadow(color: Color.black.opacity(0.05), radius: 5, x: 0, y: 2)
                    .onTapGesture {
                        showStolenTip.toggle()
                    }
                }
                .padding(.horizontal, 20)
                .padding(.top, 30)
                
                if viewModel.showThiefAlert {
                    VStack {
                        Text("Ê™∏Ê™¨Â∞èÂÅ∑üëª‰æÜ‰∫ÜÔºÅ")
                            .font(.system(size: 16, weight: .bold))
                        Text(String(format: NSLocalizedString("‰Ω†Ë¢´ÂÅ∑‰∫Ü%dÊùØÊ™∏Ê™¨Ê±Å", comment: ""), viewModel.stolenAmount))
                            .font(.system(size: 14))
                    }
                    .padding()
                    .background(Color.black.opacity(0.8))
                    .foregroundColor(.white)
                    .cornerRadius(10)
                    .frame(maxWidth: .infinity)
                    .padding(.horizontal, 20)
                    .padding(.top, 10)
                    .transition(.move(edge: .top).combined(with: .opacity))
                    .onAppear {
                        DispatchQueue.main.asyncAfter(deadline: .now() + 1.5) {
                            withAnimation {
                                viewModel.showThiefAlert = false
                            }
                        }
                    }
                }
                
                Spacer()
                
                // Ê™∏Ê™¨ÂúñÁâá
                ZStack {
                    // ÊéâËêΩÁöÑÊ™∏Ê™¨
                    ForEach(fallingLemons, id: \.id) { lemon in
                        Image("Lemon1")
                            .resizable()
                            .scaledToFit()
                            .frame(width: 30)
                            .offset(x: lemon.xOffset, y: lemon.yOffset)
                            .opacity(lemon.opacity)
                    }
                    
                    // Ê™∏Ê™¨Ê±ÅÂúñÁâá
                    ForEach(0..<juiceImages.count, id: \.self) { index in
                        Image("Lemon Juice")
                            .resizable()
                            .scaledToFit()
                            .frame(width: 50)
                            .scaleEffect(juiceImages[index].scale)
                            .offset(y: -60)
                            .opacity(juiceImages[index].opacity)
                    }
                    
                    Image(lemonImageName)
                        .resizable()
                        .scaledToFit()
                        .frame(maxWidth: .infinity)
                        .frame(height: UIScreen.main.bounds.height * 0.35)
                        .offset(y: -60)
                        .scaleEffect(lemonScale)
                        .onTapGesture {
                            // ÈªûÊìäÂãïÁï´
                            withAnimation(.spring(response: 0.05, dampingFraction: 0.6)) {
                                lemonScale = 0.9
                            }
                            
                            // Êí≠ÊîæÈü≥Êïà
                            if soundEnabled {
                                soundPlayer?.currentTime = 0
                                soundPlayer?.play()
                            }
                            
                            // Ëß∏ÁôºÈúáÂãï
                            if vibrationEnabled {
                                let generator = UIImpactFeedbackGenerator(style: .medium)
                                generator.impactOccurred()
                            }

                            if viewModel.lemonState == .squeezed {
                                createJuiceImages()
                            }
                            
                            if fallingAnimationEnabled {    
                                addFallingLemon()
                            }
                            viewModel.handleLemonTap()
                            
                            // ÊÅ¢Âæ©Â§ßÂ∞è
                            DispatchQueue.main.asyncAfter(deadline: .now() + 0.05) {
                                withAnimation(.spring(response: 0.05, dampingFraction: 0.6)) {
                                    lemonScale = 1.0
                                }
                            }
                        }
                }
                .padding(.bottom, 180)
            }
        }
        .overlay {
            if showLemonTip {
                VStack {
                    Text("ÈÅäÊà≤ÊèêÁ§∫")
                        .font(.headline)
                    Text("ÈªûÊìäÂÖ©‰∏ãÂèØÊ¶®‰∏ÄÊùØÊ™∏Ê™¨Ê±Å")
                        .font(.subheadline)
                }
                .padding()
                .background(Color.white)
                .cornerRadius(10)
                .shadow(radius: 5)
            }
            
            if showStolenTip {
                VStack {
                    Text("ÈÅäÊà≤ÊèêÁ§∫")
                        .font(.headline)
                    Text("‰∏ÄÂÆöÈªûÊìäÊ¨°Êï∏ÂÖßÊúâ25%Âà∞75%Ê©üÁéáË¢´ÂÅ∑Ëµ∞25%Âà∞75%ÊìÅÊúâÊ™∏Ê™¨Ê±Å")
                        .font(.subheadline)
                        .multilineTextAlignment(.center)
                }
                .padding()
                .background(Color.white)
                .cornerRadius(10)
                .shadow(radius: 5)
            }
        }
        .sheet(isPresented: $showSettings) {
            SettingsView()
        }
    }
    
    private func createJuiceImages() {
        juiceImages = []
        var randomPositions: [(x: CGFloat, y: CGFloat)] = []
        
        // ÂÖàÁîüÊàêÊâÄÊúâÈö®Ê©ü‰ΩçÁΩÆ
        for _ in 0..<5 {
            let randomX = CGFloat.random(in: -10...10)
            let randomY = CGFloat.random(in: -10...10)
            randomPositions.append((x: randomX, y: randomY))
            
            let randomScale = CGFloat.random(in: 5...7)
            juiceImages.append((
                offset: .zero,
                scale: randomScale,
                opacity: 0.8
            ))
        }
        
        // ÂàÜÈñãËôïÁêÜÂãïÁï´
        for i in 0..<juiceImages.count {
            withAnimation(Animation.easeOut(duration: 0.2).delay(Double(i) * 0.03)) {
                juiceImages[i].offset = CGSize(
                    width: randomPositions[i].x,
                    height: randomPositions[i].y
                )
                juiceImages[i].opacity = 0
            }
        }
        
        // Ê∏ÖÁêÜÂãïÁï´
        DispatchQueue.main.asyncAfter(deadline: .now() + 0.35) {
            juiceImages = []
        }
    }
    
    private func addFallingLemon() {
        // Ë®àÁÆóÊñ∞Ê™∏Ê™¨ÁöÑÈö®Ê©üÊ∞¥Âπ≥‰ΩçÁΩÆ
        let xOffset = CGFloat.random(in: -200...200)
        
        // ÊâæÂà∞Ë©≤x‰ΩçÁΩÆÈôÑËøëÊúÄÈ´òÁöÑÊ™∏Ê™¨
        var highestY = screenHeight * 0.25 // Âü∫Á§éÈ´òÂ∫¶
        
        for lemon in fallingLemons {
            if abs(lemon.xOffset - xOffset) < lemonSize * 0.7 && lemon.opacity > 0.5 { // Âè™ËÄÉÊÖÆ‰∏çÈÄèÊòéÁöÑÊ™∏Ê™¨
                let topOfLemon = lemon.finalYOffset - lemonSize * 0.7 // Áïô‰∏ÄÈªûÁ©∫Èñì
                if topOfLemon < highestY {
                    highestY = topOfLemon
                }
            }
        }
        
        // Á¢∫‰øù‰∏çË∂ÖÈÅéÊúÄÂ§ßÂ†ÜÁñäÈ´òÂ∫¶
        if highestY < -maxStackHeight {
            return // Â¶ÇÊûúÂ†ÜÂæóÂ§™È´òÂ∞±‰∏çÂÜçÊ∑ªÂä†
        }
        
        let newLemon = (
            id: UUID(),
            yOffset: -screenHeight * 0.1, // Ëµ∑Âßã‰ΩçÁΩÆ
            xOffset: xOffset,
            finalYOffset: highestY,
            opacity: 1.0
        )
        
        fallingLemons.append(newLemon)
        
        // ÈñãÂßãÊéâËêΩÂãïÁï´Ôºå‰ΩøÁî®ÂΩàË∑≥ÊïàÊûúÊ®°Êì¨ÈáçÂäõ
        withAnimation(.interpolatingSpring(mass: 1.0, stiffness: 100, damping: 10, initialVelocity: 0)) {
            if let index = fallingLemons.firstIndex(where: { $0.id == newLemon.id }) {
                fallingLemons[index].yOffset = newLemon.finalYOffset
            }
        }
        
        // 15ÁßíÂæåÊ∑°Âá∫‰∏¶ÁßªÈô§
        DispatchQueue.main.asyncAfter(deadline: .now() + 14.5) {
            if let index = fallingLemons.firstIndex(where: { $0.id == newLemon.id }) {
                withAnimation(.easeOut(duration: 0.5)) {
                    fallingLemons[index].opacity = 0
                }
                
                // Ê™¢Êü•‰∏¶Êõ¥Êñ∞‰∏äÊñπÊ™∏Ê™¨ÁöÑ‰ΩçÁΩÆ
                updateLemonsAbove(removedLemon: fallingLemons[index])
            }
        }
        
        DispatchQueue.main.asyncAfter(deadline: .now() + 15.0) {
            fallingLemons.removeAll { $0.id == newLemon.id }
        }
    }
    
    private func updateLemonsAbove(removedLemon: (id: UUID, yOffset: CGFloat, xOffset: CGFloat, finalYOffset: CGFloat, opacity: Double)) {
        // ÊâæÂá∫ÊâÄÊúâÂú®Ë¢´ÁßªÈô§Ê™∏Ê™¨‰∏äÊñπÁöÑÊ™∏Ê™¨
        let affectedLemons = fallingLemons.filter { lemon in
            lemon.opacity > 0.5 && // Âè™ËÄÉÊÖÆ‰∏çÈÄèÊòéÁöÑÊ™∏Ê™¨
            abs(lemon.xOffset - removedLemon.xOffset) < lemonSize * 1.2 && // Âú®Ê∞¥Âπ≥ÁØÑÂúçÂÖß
            lemon.finalYOffset < removedLemon.finalYOffset // Âú®‰∏äÊñπ
        }
        
        // Êõ¥Êñ∞ÈÄô‰∫õÊ™∏Ê™¨ÁöÑ‰ΩçÁΩÆ
        for affectedLemon in affectedLemons {
            if let index = fallingLemons.firstIndex(where: { $0.id == affectedLemon.id }) {
                // Ë®àÁÆóÊñ∞ÁöÑÊúÄÁµÇ‰ΩçÁΩÆ
                var newHighestY = screenHeight * 0.25
                
                // Ê™¢Êü•‰∏ãÊñπÁöÑÊ™∏Ê™¨
                for lemon in fallingLemons {
                    if lemon.opacity > 0.5 && // Âè™ËÄÉÊÖÆ‰∏çÈÄèÊòéÁöÑÊ™∏Ê™¨
                       abs(lemon.xOffset - affectedLemon.xOffset) < lemonSize * 0.7 && // Âú®Ê∞¥Âπ≥ÁØÑÂúçÂÖß
                       lemon.finalYOffset > affectedLemon.finalYOffset && // Âú®‰∏ãÊñπ
                       lemon.id != affectedLemon.id { // ‰∏çÊòØËá™Â∑±
                        let topOfLemon = lemon.finalYOffset - lemonSize * 0.7
                        if topOfLemon < newHighestY {
                            newHighestY = topOfLemon
                        }
                    }
                }
                
                // ‰ΩøÁî®ÂΩàË∑≥ÂãïÁï´Êõ¥Êñ∞‰ΩçÁΩÆ
                withAnimation(.interpolatingSpring(mass: 1.0, stiffness: 100, damping: 10, initialVelocity: 0)) {
                    fallingLemons[index].finalYOffset = newHighestY
                    fallingLemons[index].yOffset = newHighestY
                }
            }
        }
    }
    
    private var lemonImageName: String {
        switch viewModel.lemonState {
        case .full: return "Lemon1"
        case .squeezed: return "Lemon2"
        case .empty: return "Lemon Juice"
        }
    }
}

struct SettingsView: View {
    @AppStorage("vibrationEnabled") private var vibrationEnabled = true
    @AppStorage("soundEnabled") private var soundEnabled = true
    @AppStorage("autoSqueezeEnabled") private var autoSqueezeEnabled = false
    @AppStorage("darkModeEnabled") private var darkModeEnabled = false
    @AppStorage("fallingAnimationEnabled") private var fallingAnimationEnabled = true
    @Environment(\.dismiss) private var dismiss
    
    var body: some View {
        NavigationView {
            ZStack {
                Image("background")
                    .resizable()
                    .scaledToFill()
                    .edgesIgnoringSafeArea(.all)
                
                VStack(spacing: 20) {
                    HStack {
                        Text("Ë®≠ÂÆö")
                            .font(.title.bold())
                        Spacer()
                        Button(action: {
                            dismiss()
                        }) {
                            Image(systemName: "xmark.circle.fill")
                                .font(.title2)
                                .foregroundColor(.gray)
                        }
                    }
                    .padding(.top, hasNotch() ? 70 : 110)
                    .padding(.horizontal, 30)
                    
                    VStack(spacing: 15) {
                        Toggle("ÈúáÂãïÊïàÊûú", isOn: $vibrationEnabled)
                            .padding()
                            .background(RoundedRectangle(cornerRadius: 15).fill(Color.white.opacity(0.9)))
                            .shadow(color: Color.black.opacity(0.1), radius: 5, x: 0, y: 2)
                        
                        Toggle("ÈªûÊìäÈü≥Êïà", isOn: $soundEnabled)
                            .padding()
                            .background(RoundedRectangle(cornerRadius: 15).fill(Color.white.opacity(0.9)))
                            .shadow(color: Color.black.opacity(0.1), radius: 5, x: 0, y: 2)
                        
                        Toggle("ÊéâËêΩÊïàÊûú", isOn: $fallingAnimationEnabled)
                            .padding()
                            .background(RoundedRectangle(cornerRadius: 15).fill(Color.white.opacity(0.9)))
                            .shadow(color: Color.black.opacity(0.1), radius: 5, x: 0, y: 2)
                        
                        Toggle("Ëá™ÂãïÊ¶®Ê™∏Ê™¨ÔºàÂç≥Â∞áÊé®Âá∫Ôºâ", isOn: $autoSqueezeEnabled)
                            .padding()
                            .background(RoundedRectangle(cornerRadius: 15).fill(Color.white.opacity(0.9)))
                            .shadow(color: Color.black.opacity(0.1), radius: 5, x: 0, y: 2)
                        
                        Toggle("Ê∑±Ëâ≤Ê®°ÂºèÔºàÂç≥Â∞áÊé®Âá∫Ôºâ", isOn: $darkModeEnabled)
                            .padding()
                            .background(RoundedRectangle(cornerRadius: 15).fill(Color.white.opacity(0.9)))
                            .shadow(color: Color.black.opacity(0.1), radius: 5, x: 0, y: 2)
                    }
                    .padding(.horizontal, 30)
                    
                    Text(String(format: NSLocalizedString("ÁâàÊú¨ %@", comment: ""), "1.0.0"))
                        .font(.caption)
                        .foregroundColor(.gray)
                        .padding(.top, 30)
                    
                    Spacer()
                }
            }
        }
    }
}
